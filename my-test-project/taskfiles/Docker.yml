# https://taskfile.dev

version: '3'

vars:
  COMPOSE_FILES: '{{ .COMPOSE_FILES | default "./compose/local/docker-compose.yml" }}'
  DOCKER_SERVICES: '{{ .DOCKER_SERVICES | default "" }}'
  DETACHED: '{{ .DETACHED | default "" }}'
  UP_FLAGS: '{{ .UP_FLAGS | default "--remove-orphans" }}'
  DOWN_FLAGS: '{{ .DOWN_FLAGS | default "--remove-orphans" }}'

tasks:
  up:
    desc: Start docker services for local development
    deps:
      - :env
    cmds:
      - docker compose -f {{.COMPOSE_FILES}} up {{.DETACHED}} {{.UP_FLAGS}} {{.DOCKER_SERVICES}}

  down:
    desc: Stop docker services (keep volumes)
    cmds:
      - docker compose -f {{.COMPOSE_FILES}} down {{.DOWN_FLAGS}}

  reset:
    desc: Stop docker services and remove volumes (clean environment)
    cmds:
      - docker compose -f {{.COMPOSE_FILES}} down -v {{.DOWN_FLAGS}}

  restart:
    desc: Restart docker services (keeps volumes)
    cmds:
      - task: down
      - task: up

  rebuild:
    desc: Rebuild and start (use when Dockerfile/deps changed)
    deps:
      - :env
    cmds:
      - docker compose -f {{.COMPOSE_FILES}} up {{.DETACHED}} --build {{.UP_FLAGS}} {{.DOCKER_SERVICES}}

  logs:
    desc: Follow logs (optionally specify DOCKER_SERVICES="mailpit")
    cmds:
      - docker compose -f {{.COMPOSE_FILES}} logs -f --tail=200 {{.DOCKER_SERVICES}}

  status:
    desc: Show containers for this compose project
    cmds:
      - docker compose -f {{.COMPOSE_FILES}} ps

  prune:
    desc: Cleanup unused build cache (safe) + dangling images
    cmds:
      - docker builder prune -f
      - docker image prune -f
